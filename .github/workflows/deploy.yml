name: Deploy OpenClaw to Azure Container Apps

on:
    push:
        branches:
            - main # Triggers the pipeline on every push to the main branch
    workflow_dispatch: # Allows you to run the workflow manually from the GitHub UI

env:
    REGISTRY_NAME: asireonclaw
    IMAGE_NAME: openclaw
    RESOURCE_GROUP: asireon-claw

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            # 1. Pull down your forked OpenClaw code
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2. Authenticate securely with Azure
            - name: Log in to Azure
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            # 3. Authenticate with your Container Registry
            - name: Log in to Azure Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY_NAME }}.azurecr.io
                  username: ${{ env.REGISTRY_NAME }}
                  password: ${{ secrets.ACR_PASSWORD }}

            # 4. Build the custom Docker image and tag it with the commit SHA
            - name: Build and Push Docker Image
              run: |
                  docker build -t ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
                  docker push ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

            # 5. Execute the Bicep template to update the Container App with the new image
            - name: Deploy Infrastructure and App via Bicep
              uses: azure/arm-deploy@v2
              with:
                  resourceGroupName: ${{ env.RESOURCE_GROUP }}
                  template: ./main.bicep
                  parameters: >
                      containerImage=${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
                      registryServer=${{ env.REGISTRY_NAME }}.azurecr.io
                      registryUsername=${{ env.REGISTRY_NAME }}
                      registryPassword=${{ secrets.ACR_PASSWORD }}
                      openclawStaticToken=${{ secrets.OPENCLAW_STATIC_TOKEN }}
                      openAiApiKey=${{ secrets.OPENAI_API_KEY }}
                      anthropicApiKey=${{ secrets.ANTHROPIC_API_KEY }}
